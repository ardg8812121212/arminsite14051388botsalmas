
@if (apiKeyError()) {
  <div class="bg-red-900 border border-red-500 text-red-200 px-4 py-3 rounded-lg relative" role="alert">
    <strong class="font-bold">خطای پیکربندی!</strong>
    <span class="block sm:inline">{{ apiKeyError() }}</span>
  </div>
} @else {
  <div class="flex flex-col h-[calc(100vh-250px)] max-w-4xl mx-auto">
    
    @if (!uploadedFile()) {
      <div class="flex-grow flex items-center justify-center">
        <div class="w-full max-w-lg p-8 text-center bg-gray-800 border-2 border-dashed border-gray-600 rounded-lg">
          <span class="material-symbols-outlined text-6xl text-gray-500">upload_file</span>
          <h2 class="mt-4 text-xl font-medium text-gray-200">فایل خود را آپلود کنید</h2>
          <p class="mt-2 text-sm text-gray-400">فایل PDF، Word یا عکس خود را برای تحلیل بکشید و رها کنید یا انتخاب کنید.</p>
          <label for="file-upload" class="mt-6 inline-block cursor-pointer bg-cyan-600 text-white rounded-full py-3 px-6 hover:bg-cyan-500 transition-colors duration-200">
            انتخاب فایل
          </label>
          <input id="file-upload" type="file" class="hidden" (change)="onFileChange($event)" accept=".pdf,.doc,.docx,.png,.jpg,.jpeg,.txt">
          @if (fileError()) {
            <p class="mt-4 text-sm text-red-400">{{ fileError() }}</p>
          }
        </div>
      </div>
    } @else {
      <!-- Chat Interface -->
      <div class="flex flex-col flex-grow bg-gray-800 rounded-lg shadow-2xl overflow-hidden">
        <div class="p-4 bg-gray-700 border-b border-gray-600 flex justify-between items-center">
          <div class="flex items-center gap-3 min-w-0">
            <span class="material-symbols-outlined text-cyan-400">description</span>
            <span class="font-bold text-gray-200 truncate">{{ uploadedFile()?.name }}</span>
          </div>
          <button (click)="removeFile()" class="text-gray-400 hover:text-white transition-colors flex-shrink-0">
            <span class="material-symbols-outlined">close</span>
          </button>
        </div>

        <div #chatContainer class="flex-grow p-6 overflow-y-auto space-y-6">
          @if (messages().length === 0) {
            <div class="text-center text-gray-400">
              <p class="text-lg">فایل با موفقیت بارگذاری شد.</p>
              <p>حالا می‌توانید سوالات خود را در مورد این فایل بپرسید.</p>
            </div>
          }
          @for (message of messages(); track $index) {
            <div class="flex" [class.justify-end]="message.role === 'user'">
              <div 
                class="max-w-lg lg:max-w-xl px-5 py-3 rounded-2xl" 
                [class.bg-cyan-600]="message.role === 'user'" 
                [class.text-white]="message.role === 'user'"
                [class.bg-gray-700]="message.role === 'model'"
                [class.text-gray-200]="message.role === 'model'"
              >
                <p class="whitespace-pre-wrap">{{ message.text }}</p>
              </div>
            </div>
          }
          @if (isLoading()) {
            <div class="flex justify-start">
                <div class="bg-gray-700 px-5 py-3 rounded-2xl flex items-center space-x-3 space-x-reverse">
                    <div class="typing-dot"></div>
                    <div class="typing-dot" style="animation-delay: 0.2s;"></div>
                    <div class="typing-dot" style="animation-delay: 0.4s;"></div>
                </div>
            </div>
          }
        </div>
        <div class="p-4 bg-gray-800 border-t border-gray-700">
          <form (submit)="sendMessage()" class="flex items-center gap-4">
            <input
              type="text"
              [(ngModel)]="currentMessage"
              name="message"
              placeholder="در مورد فایل بپرسید..."
              class="flex-grow bg-gray-700 text-gray-200 border border-gray-600 rounded-full py-3 px-5 focus:outline-none focus:ring-2 focus:ring-cyan-500 transition"
              [disabled]="isLoading()"
            />
            <button
              type="submit"
              class="bg-cyan-600 text-white rounded-full p-3 hover:bg-cyan-500 disabled:bg-gray-500 disabled:cursor-not-allowed transition-colors duration-200"
              [disabled]="isLoading() || currentMessage().trim() === ''"
            >
              <span class="material-symbols-outlined">send</span>
            </button>
          </form>
        </div>
      </div>
    }

  </div>
}
